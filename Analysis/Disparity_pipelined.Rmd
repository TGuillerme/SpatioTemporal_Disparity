---
title: "new disparity analysis"
author: "Thomas Guillerme"
date: "`r Sys.Date()`"
output:
  html_document:
    fig_width: 6
    fig_height: 6
---

STD pipelined analysis v2.0!
===============

New version of the spatio-temporal disparity analysis in mammals around the K-Pg boundary (using Beck's and Halliday's data)


Before starting
===============

Loading the package
-----------------------------------

First we need to install the packages.
Note that if the packages need to be installed manually (the following code is not evaluated, assuming you have these packages already installed).
To download them, just copy/paste the following code.

```{r, eval = FALSE}
# The latest version of devtools and ape
if(!require(devtools)) install.packages("devtools")
if(!require(ape)) install.packages("ape")

## The latest version of Claddis (on development on my own branch)
install_github("TGuillerme/Claddis")

## The latest version of dispRity 
install_github("TGuillerme/dispRity")
```

Loading the data
-----------------------------------

Using the data from Beck & Lee 2014 (same as previous one) as well as Halliday & Goswami 2015.
Halliday's data contains more trees so a next version of the analysis will use the whole tree distribution for both data sets (`mulTree` style).
The FADLAD tables are downloaded from the paleoDataBase with each first and last occurrence datum being the most inclusive (i.e. taking the maximum and minimum time span of the genus).

```{r}
set.seed(123)
## Loading the packages
library(Claddis) ; library(dispRity)

## Loading the discrete morphological matrix
matrix_Beck <- ReadMorphNexus("../Data/2014-Beck-ProcB-matrix-morpho.nex")
matrix_Hall <- ReadMorphNexus("../Data/2015-Halliday-LinSoc-matrix-morpho.nex")

## Loading the tree
tree_Beck <- read.nexus("../Data/2014-Beck-ProcB-TEM.tre")
tree_Hall <- read.nexus("../Data/2015-Halliday-LinSoc-tree.nex")[[1]]

## Arbitrarily solving 0 branch lengths in Halliday's tree by setting them to
## 1% of the minimum branch length
zero_brlen <- which(tree_Hall$edge.length == 0)
min_brlen <- min(tree_Hall$edge.length[-zero_brlen])*0.1
tree_Hall$edge.length[which(tree_Hall$edge.length == 0)] <- min_brlen

## Making sure the tree and the matrix are matching
clean.MorphNexus <- function(matrix, tree) {
    cleaned_data <- clean.data(matrix$matrix, tree)
    tree <- cleaned_data$tree
    matrix$matrix <- cleaned_data$data
    return(list(tree, matrix))
}

tmp <- clean.MorphNexus(matrix_Beck, tree_Beck)
tree_Beck <- tmp[[1]] ; matrix_Beck <- tmp[[2]]

tmp <- clean.MorphNexus(matrix_Hall, tree_Hall)
tree_Hall <- tmp[[1]] ; matrix_Hall <- tmp[[2]]


## Adding node labels to the tree
tree_Beck <- makeNodeLabel(tree_Beck, method = "number", prefix = "n")
tree_Hall <- makeNodeLabel(tree_Hall, method = "number", prefix = "n")

## Adding root.time to the tree
tree_Beck$root.time <- max(tree.age(tree_Beck)[,1])
tree_Hall$root.time <- max(tree.age(tree_Hall)[,1])

## loading the first/last occurrence data
FADLAD_Beck <- read.csv("../Data/Beck2014_FADLAD.csv", row.names = 1)
FADLAD_Hall <- read.csv("../Data/Halliday2015_FADLAD.csv", row.names = 1)
```


Ordination
===============

Ancestral states reconstruction
-----------------------------------

First let's recreate the nodal states but excluding any estimation with less than 0.95 scaled likelihood value.

```{r, eval = FALSE}
## Estimating the ancestral states (with a uncertainty threshold of 0.95)
matrix_nodes_Beck <- AncStateEstMatrix(matrix_Beck, tree_Beck,
    estimate.allchars = TRUE, uncertainty.threshold = 0.95)
## Saving the matrix
save(matrix_nodes_Beck, file = "../Data/ancestral_states_beck2014.Rda")

## Estimating the ancestral states (with a uncertainty threshold of 0.95)
matrix_nodes_Hall <- AncStateEstMatrix(matrix_Hall, tree_Hall,
    estimate.allchars = TRUE, uncertainty.threshold = 0.95)
## Saving the matrix
save(matrix_nodes_Hall, file = "../Data/ancestral_states_halliday2015.Rda")
```

This takes some time (couple of hours) so it can be skipped.

```{r}
## Loading the matrix
load("../Data/ancestral_states_beck2014.Rda")
load("../Data/ancestral_states_halliday2015.Rda")
## The matrix was assigned to the object matrix_nodes (see above).

## Adding the node names as row names
row.names(matrix_nodes_Beck) <- tree_Beck$node.label
row.names(matrix_nodes_Hall) <- tree_Hall$node.label

## Combining the tips and the nodes in the same matrix
matrix_Beck$matrix <- rbind(matrix_Beck$matrix, matrix_nodes_Beck) 
matrix_Hall$matrix <- rbind(matrix_Hall$matrix, matrix_nodes_Hall) 
```

Distance matrix
-----------------------------------

Let's then calculate the distance matrix (using Gower's distance).
Same thing, the step takes some time (couple of minutes) so can be skipped for convenience.

```{r, eval = FALSE}
## Calculating the Gower distance
matrix_dist_Beck <- MorphDistMatrix.fast(matrix_Beck, distance = "Gower")
save(matrix_dist_Beck, file = "../Data/distmatrix_beck2014.Rda")
matrix_dist_Hall <- MorphDistMatrix.fast(matrix_Hall, distance = "Gower")
save(matrix_dist_Hall, file = "../Data/distmatrix_halliday2015.Rda")
```

Ordination
-----------------------------------

```{r}
## Loading the distance matrices
load("../Data/distmatrix_beck2014.Rda")
load("../Data/distmatrix_halliday2015.Rda")

#### TO FIX PROPERLY!
#
# Replacing NAs (incomparable taxa) by median distance (not excellent practice)
# But there's only 8 NAs in 120409 distances (0.006%) so it won't influence the
# results (I guess)
matrix_dist_Hall[which(is.na(matrix_dist_Hall))] <- mean(matrix_dist_Hall, na.rm = TRUE)
#
#### TO FIX PROPERLY!

## Ordinating the matrices
matrix_ord_Beck <- cmdscale(matrix_dist_Beck,
                            k = nrow(matrix_dist_Beck) - 2, add = T)$points
matrix_ord_Hall <- cmdscale(matrix_dist_Hall,
                            k = nrow(matrix_dist_Hall) - 2, add = T)$points
```

Disparity through time
===============

Time slicing
-----------------------------------

First let's slice the data into 33 slices (every 5 Mya) using the gradual model.

```{r}
## Creating the time slices
time_slices <- rev(seq(from = 0, to = 120, by = 5))

## Creating the time series
time_series_Beck <- time.series(matrix_ord_Beck, tree_Beck,
    method = "continuous", time = time_slices, model = "gradual",
    FADLAD = FADLAD_Beck, verbose = TRUE)
time_series_Hall <- time.series(matrix_ord_Hall, tree_Hall,
    method = "continuous", time = time_slices, model = "gradual",
    FADLAD = FADLAD_Hall, verbose = TRUE)
```

Bootstrapping
-----------------------------------

Then let's bootstrap 1000 times.

```{r}
## Bootstrapping the time series
time_series_Beck_bs <- boot.matrix(time_series_Beck, bootstrap = 1000)
time_series_Hall_bs <- boot.matrix(time_series_Hall, bootstrap = 1000)
```

Calculating disparity
-----------------------------------

And now let's calculate disparity.
Couple of changes here, first, disparity is now calculated as two distributions (and then summarised as the median later on) and two aspects are now measured:
 *  the distances between each taxa in a slice and the their centroid (as before)
 *  the distances between each taxa in a slice and the overall centre of the morphospace.
The first distribution tells us about the *size* of the taxa's morphospace at each slice (i.e. the space occupied by the taxa at each size) and the second tells us about the *position* of the taxa's morphospace at each slice (i.e. where in the morphospace they are).
The reason for using distributions becomes more obvious later on in the testing part.

```{r}
## Calculating the distance from the centroids
dist_centroids_Beck <- dispRity(time_series_Beck_bs, metric = centroids)
dist_centroids_Hall <- dispRity(time_series_Hall_bs, metric = centroids)

## Calculating the distance from the centre of the space
dist_centre_Beck <- dispRity(time_series_Beck_bs, metric = centroids,
                               centroid = rep(0, ncol(matrix_ord_Beck)))
dist_centre_Hall <- dispRity(time_series_Hall_bs, metric = centroids,
                               centroid = rep(0, ncol(matrix_ord_Hall)))

## Calculating the medians of the distances from centroids/centre
med_dist_centroids_Beck <- dispRity(dist_centroids_Beck, metric = median)
med_dist_centroids_Hall <- dispRity(dist_centroids_Hall, metric = median)
med_dist_centre_Beck <- dispRity(dist_centre_Beck, metric = median)
med_dist_centre_Hall <- dispRity(dist_centre_Hall, metric = median)
```

Results
===============

Plot
-----------------------------------

```{r, fig.width=6, fig.height=6}
## Graphical parameters
op <- par(mfrow = c(2,2), bty = "n")

## Plotting the distance from centroids
plot(med_dist_centroids_Beck, main = "Beck 2014", elements = TRUE,
    ylab = c("Median distance from centroids", ""), xlab = "")
abline(v = 12, col = "red")
plot(med_dist_centroids_Hall, main = "Halliday 2015", ylab = c("", "Taxa"),
    xlab = "", elements = TRUE)
abline(v = 12, col = "red")

## Plotting the distances from centre
plot(med_dist_centre_Beck, ylab = c("Median distance from center", ""), 
    xlab = "Age (Mya)", elements = TRUE)
abline(v = 12, col = "red")
plot(med_dist_centre_Hall, ylab = c("", "Taxa"), xlab = "Age (Mya)",
    elements = TRUE)
abline(v = 12, col = "red")

## Resetting graphical parameters
par(op)
```

The dashed line represents the number of taxa in each slice.

Testing
-----------------------------------

Before, we compared the distributions of the bootstrapped medians between slices

```{r}
## Extracting the bootstrapped median distances from centroids from slices 19
## and 20 for the example:
disparity <- get.dispRity(med_dist_centroids_Beck, what = c(12:13))

## Checking the difference between the two slices
test.dispRity(disparity, test = t.test)
```

The problem is that (1) we were only comparing the medians and (2) we were actually testing the effect of the bootstrap not of the changes in disparity (i.e. a significant p-value would mean that there is a difference in the mean of the distribution of medians (which are in turn just the results of the bootstraps)).
This basically results in really big degrees of freedom (see `parameter`) and will probably tend to always significant results as the amount of bootstraps increase.

To avoid this problem, we can compare the distributions of disparity rather than their central tendencies and bootstrap these comparisons rather than the distributions (i.e. performing the distributions comparisons multiple time with each time a pseudo-replicate (the bootstrap) of the distribution).

```{r}
## Extracting the bootstrapped distribution of distances from centroids
## from slices 19 and 20 for the example:
disparity <- get.dispRity(dist_centroids_Beck, what = c(12:13))

## Checking the difference between the two slices for each bootstrap
test.dispRity(disparity, test = t.test, concatenate = FALSE)
```

Now we have a distribution of statistics and parameters (note that the degrees of freedom are now back to a normal level).
We can thus use this distribution to test our hypothesis, in this case, we have a low chance of rejecting H0 and being wrong (i.e. pvalue < 0.05) in less than 2.5% of the replicates!
In other words, the distributions are the same (median p-value of 0.4).

And now we can apply that to both the size of the taxa's sub-morphospace through time and their position:

```{r}
## Testing any change in group size (centroids) after K-Pg
test.dispRity(get.dispRity(dist_centroids_Beck, what = c(12:20)),
    test = t.test, concatenate = FALSE, comparisons = "referential",
    correction = "bonferroni")
test.dispRity(get.dispRity(dist_centroids_Hall, what = c(12:20)),
    test = t.test, concatenate = FALSE, comparisons = "referential",
    correction = "bonferroni")
```

When looking at Beck's data set, there is (as before) no significant expansion of the eutherian morphospace after the K-Pg event.
However, when looking at Halliday's data, there is a consistent significant expansion in the 5 Mya after the K-Pg event (97.5% of the p-values < 0.001!) as well with a less consistent one in the following 10 Mya (75% of the p-values < 0.005).
After that though, the morphospace size seems to go down to pre K-Pg levels (but that might be due to the under sampling).

```{r}
## Testing any change in group position (centre) after K-Pg
test.dispRity(get.dispRity(dist_centre_Beck, what = c(12:20)),
    test = t.test, concatenate = FALSE, comparisons = "referential",
    correction = "bonferroni")
test.dispRity(get.dispRity(dist_centre_Hall, what = c(12:20)),
    test = t.test, concatenate = FALSE, comparisons = "referential",
    correction = "bonferroni")
```

When looking at the shifts in morphospace, in Beck's dataset, there is no significant ones right after the K-Pg event.
However, it seems that the morphospace shifts after the PETM (around 35 Mya, see figure)

For Halliday's one however, there is a shift that starts 5 Mya after the K-Pg event and holds for 10 Mya before coming back to the pre K-Pg position.
<!-- 
Disparity through time
-----------------------------------
```{r}
## Running the sequential tests on the centroids
seq_centroids_Beck <- test.dispRity(dist_centroids_Beck, test = sequential.test,
    family = gaussian, concatenate = FALSE, correction = "bonferroni")
seq_centroids_Hall <- test.dispRity(dist_centroids_Hall, test = sequential.test,
    family = gaussian, concatenate = FALSE, correction = "bonferroni")
## Running the sequential tests on the centroids
seq_centre_Beck <- test.dispRity(dist_centre_Beck, test = sequential.test,
    family = gaussian, concatenate = FALSE, correction = "bonferroni")
seq_centre_Hall <- test.dispRity(dist_centre_Hall, test = sequential.test,
    family = gaussian, concatenate = FALSE, correction = "bonferroni")

```

```{r, fig.width=6, fig.height=6}
## Graphical parameters
op <- par(mfrow = c(2,2), bty = "n")

## Plotting the distance from centroids
plot(med_dist_centroids_Beck, main = "Beck 2014", elements = TRUE,
    ylab = c("Median distance from centroids", ""), xlab = "")
abline(v = 12, col = "red")
plot(seq_centroids_Beck, lines.args = list(col = "red", lty = 3), add = TRUE)
plot(med_dist_centroids_Hall, main = "Halliday 2015", ylab = c("", "Taxa"),
    xlab = "", elements = TRUE)
abline(v = 12, col = "red")
plot(seq_centroids_Hall, lines.args = list(col = "red", lty = 3), add = TRUE)

## Plotting the distances from centre
plot(med_dist_centre_Beck, ylab = c("Median distance from center", ""), 
    xlab = "Age (Mya)", elements = TRUE)
abline(v = 12, col = "red")
plot(seq_centre_Beck, lines.args = list(col = "red", lty = 3), add = TRUE)
plot(med_dist_centre_Hall, ylab = c("", "Taxa"), xlab = "Age (Mya)",
    elements = TRUE)
abline(v = 12, col = "red")
plot(seq_centre_Hall, lines.args = list(col = "red", lty = 3), add = TRUE)

## Resetting graphical parameters
par(op)
```
 -->
Rarefaction
===============

Although Beck is undersampling, maybe Halliday is oversampling.
Here are the rarefied results with 10 taxa in each bootstrap pseudo-replication.

```{r}
## Rarefying the time series
time_series_Beck_rar <- boot.matrix(time_series_Beck, bootstrap = 1000,
    rarefaction = 10)
time_series_Hall_rar <- boot.matrix(time_series_Hall, bootstrap = 1000,
    rarefaction = 10)
```


```{r}
## Calculating the distance from the centroids
dist_centroids_Beck_rar <- dispRity(time_series_Beck_rar, metric = centroids)
dist_centroids_Hall_rar <- dispRity(time_series_Hall_rar, metric = centroids)

## Calculating the distance from the centre of the space
dist_centre_Beck_rar <- dispRity(time_series_Beck_rar, metric = centroids,
                               centroid = rep(0, ncol(matrix_ord_Beck)))
dist_centre_Hall_rar <- dispRity(time_series_Hall_rar, metric = centroids,
                               centroid = rep(0, ncol(matrix_ord_Hall)))

## Calculating the medians of the distances from centroids/centre
med_dist_centroids_Beck_rar <- dispRity(dist_centroids_Beck_rar, metric = median)
med_dist_centroids_Hall_rar <- dispRity(dist_centroids_Hall_rar, metric = median)
med_dist_centre_Beck_rar <- dispRity(dist_centre_Beck_rar, metric = median)
med_dist_centre_Hall_rar <- dispRity(dist_centre_Hall_rar, metric = median)
```

```{r, fig.width=6, fig.height=6}
## Graphical parameters
op <- par(mfrow = c(2,2), bty = "n")

## Plotting the distance from centroids
plot(med_dist_centroids_Beck_rar, main = "Beck 2014 (rarefied)",
    ylab = "Median distance from centroids", xlab = "")
abline(v = 12, col = "red")
plot(med_dist_centroids_Hall_rar, main = "Halliday 2015 (rarefied)", ylab = "",
    xlab = "")
abline(v = 12, col = "red")

## Plotting the distances from centre
plot(med_dist_centre_Beck_rar, ylab = "Median distance from center",
    xlab = "Age (Mya)")
abline(v = 12, col = "red")
plot(med_dist_centre_Hall_rar, ylab = "", xlab = "Age (Mya)")
abline(v = 12, col = "red")

## Resetting graphical parameters
par(op)
```

```{r}
## Testing any change in group size (centroids) after K-Pg
test.dispRity(get.dispRity(dist_centroids_Beck_rar, what = c(12:20)),
    test = t.test, concatenate = FALSE, comparisons = "referential",
    correction = "bonferroni")
test.dispRity(get.dispRity(dist_centroids_Hall_rar, what = c(12:20)),
    test = t.test, concatenate = FALSE, comparisons = "referential",
    correction = "bonferroni")
```

Now there is no more significant change morphospace size in both dataset.

```{r}
## Testing any change in group position (centre) after K-Pg
test.dispRity(get.dispRity(dist_centre_Beck_rar, what = c(12:20)),
    test = t.test, concatenate = FALSE, comparisons = "referential",
    correction = "bonferroni")
test.dispRity(get.dispRity(dist_centre_Hall_rar, what = c(12:20)),
    test = t.test, concatenate = FALSE, comparisons = "referential",
    correction = "bonferroni")
```

Nor is there any change in morphospace position...


