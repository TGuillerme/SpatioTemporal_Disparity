%LaTeX template : http://systbio.org/files/SB_LaTeX_Template_txt_extension.txt
%Author instructions: http://www.oxfordjournals.org/our_journals/sysbio/for_authors/ms_preparation.html

\documentclass[12pt,letterpaper]{article}
\usepackage{natbib}

%Packages
\usepackage{pdflscape}
\usepackage{fixltx2e}
\usepackage{textcomp}
\usepackage{fullpage}
\usepackage{float}
\usepackage{latexsym}
\usepackage{url}
\usepackage{epsfig}
\usepackage{graphicx}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{bm}
\usepackage{array}
\usepackage[version=3]{mhchem}
\usepackage{ifthen}
\usepackage{caption}
\usepackage{hyperref}
\usepackage{amsthm}
\usepackage{amstext}
\usepackage{enumerate}
\usepackage[osf]{mathpazo}
\usepackage{dcolumn}
\usepackage{lineno}
\pagenumbering{arabic}


%Pagination style and stuff
\linespread{2}
\raggedright
\setlength{\parindent}{0.5in}
\setcounter{secnumdepth}{0} 
\renewcommand{\section}[1]{%
\bigskip
\begin{center}
\begin{Large}
\normalfont\scshape #1
\medskip
\end{Large}
\end{center}}
\renewcommand{\subsection}[1]{%
\bigskip
\begin{center}
\begin{large}
\normalfont\itshape #1
\end{large}
\end{center}}
\renewcommand{\subsubsection}[1]{%
\vspace{2ex}
\noindent
\textit{#1.}---}
\renewcommand{\tableofcontents}{}
%\bibpunct{(}{)}{;}{a}{}{,}

%---------------------------------------------
%
%       START
%
%---------------------------------------------

%Submitting to: Evolution (thorough method + applied data)
%               Proc B (nice story + thorough method in the supplementaries?)
%               MEE (new method (time slicing) + increment on former methods (disparity)) 

% NC: Make sure to format for whichever journal we choose...

\begin{document}

%Running head
\begin{flushright}
Version dated: \today
\end{flushright}
\bigskip
\noindent RH: Tempo and mode in mammalian evolution

\bigskip
\medskip
\begin{center}

\noindent{\Large \bf Cretaceous-Palaeogene extinction does not affect mammalian disparity.} 
% NC: still think this might need some work

\bigskip

\noindent {\normalsize \sc Thomas Guillerme$^1$$^,$$^2$$^*$, and Natalie Cooper$^1$$^,$$^2$}\\
\noindent {\small \it 
$^1$School of Natural Sciences, Trinity College Dublin, Dublin 2, Ireland.\\
$^2$Trinity Centre for Biodiversity Research, Trinity College Dublin, Dublin 2, Ireland.}\\
\end{center}
\medskip
\noindent{*\bf Corresponding author.} \textit{Zoology Building, Trinity College Dublin, Dublin 2, Ireland; E-mail: guillert@tcd.ie; Fax: +353 1 6778094; Tel: +353 1 896 2571.}\\
\vspace{1in}

%Line numbering
\modulolinenumbers[1]
\linenumbers

%---------------------------------------------
%
%       ABSTRACT
%
%---------------------------------------------

\newpage
\begin{abstract}
% NC: As ever I'm ignoring this until we are finished with the rest!
%Massive global extinctions have a turn-over effect on biodiversity. When some large group of taxa suffers from a high rate of extinction, it is expected that niches becomes available for potentially unrelated clades that can undergo an adaptive radiation to fill these vacant niches.
%Therefore, in a context of current global biotic and abiotic changes, resolving this question is crucial to understand the effect of mass extinction events on biodiversity.
%The causes and effects of such events are well understood for marine organisms with a good fossil record (e.g. Ammonoidea and Foraminifera) but the effects remains unclear on some iconic vertebrate groups.

%Typically, placental mammals (eutherians) are shown by some studies to be undergoing an adaptive radiation after the Cretaceous-Palaeogene mass extinction event (K-Pg) by originating shortly before the K-Pg event and displaying high morphological evolutionary rates leading to high diversification during the Palaeogene. However, some other studies have demonstrated that eutherians originates during the Cretaceous and don't display significantly high diversification after the K-Pg event.

%Here we propose a new approach to test if eutherians undergo an adaptive radiation after the K-Pg event. We use trees containing both living and fossil taxa based on all the available data (Total Evidence) and the state-of-the-art method in dating (tip dating) along side with a better proxy for niche occupancy (morphological diversity as opposed to taxonomic diversity) and finer grain analysis through time (introducing a time slicing method).

%Our results shows that eutherians don't display significantly higher changes in morphological disparity that expected under a Brownian motion after the K-Pg boundary. We therefore propose that eutherian mammals don't undergo an adaptive radiation during the Palaeogene.

%Why is our stuff better?
%1-More accurate timing (TEM+tip dating vs. molecular node date or morphological parsimony)
%2-Better proxy for niche occupancy (morphological disparity + diversity vs. species diversity) (but niches concept is shite anyway)
%3-Better measure for disparity (centroid distance vs. Foote's quartet)
%4-Two evolutionary models instead of one for looking at disparity through time (punctuated+constant vs. punctuate)
%5-Systematic time units for looking at disparity through time (slices vs. intervals)

\end{abstract}

\noindent (Keywords: disparity, diversity, punctuated equilibrium, gradualism, time slicing)\\
% NC: Note that keywords are things that aren't in the title of the paper
\vspace{1.5in}

\newpage 

%---------------------------------------------
%
%       INTRODUCTION
%
%---------------------------------------------

\section{Introduction}

%-Macroevolution / niches / crisis in biodiversity
%-Diversity in mammals is known to increase blablabla (Stadler)
%Cheeky selling line: in the context of the anthropocene extinction event, blabalbal
%-However, not much is known about the disparity. We think disparity is a more functional measure of biodiversity since it is expected that more disparate species occupies more disparate niches and therefore have a globally more important role in the ecosystems.
%-We use a novel approach for looking at disparity as the spread of the data in a N dimensional character-space (centroid - Finlay Cooper)
%-Problem with timing the events (O'Leary vs Meredith). Here we look at disparity on total evidence trees that contain morphological information but are backed-up by molecular data.

% TG: I reworked the whole thing. It seems a bit short to me but I guess that'll need some adjusting/precisions.
% NC: I think the length is fine. Short = good.

% 1ยง mass extinctions = bad. Loss of species (e.g. P/T 95%). But what comes after is more interesting: sp richness can increase, decrease or stay constant. So can sp niche occupancy. But it is not always link (ruta and stuff). Opportuinities, interaction, ecological role etc... A classical example is the rise of mammals
%Mass extinctions result in catastrophic declines in global biodiversity \citep{RaupPT,BentonPT,rennetime2013,Brusatte2015}. % TG: Maybe find a more catchy sentence.
Throughout history, life on earth has suffered a series of sudden catastrophic extinction events resulting in drastic declines in global biodiversity \citep[e.g.][]{RaupPT,BentonPT,rennetime2013,Brusatte2015}. % TG Maybe that one is better? Sudden and catastrophic contransting with long-term and varied in the second sentence?
However, the long-term effects of mass extinctions are more varied \citep{Erwin1998344}, and include increases in species richness in some clades \citep{friedmanexplosive2010}, species richness declines in others \citep{Benton85}, changes in morphological diversity \cite{Ciampaglio2001,Ciampaglio200,kornextinction2013} and shifts in ecological dominance \citep[e.g.][]{Brusatte12092008,toljagictriassic-jurassic2013,bensonfaunal2014}.
These shifts are characterized by the decline of one clade that is replaced by a different unrelated clade with a similar ecological role \citep{Brusatte12092008} (e.g. Brachiopoda and Bivalvia at the end Permian extinction \citealt{Sepkiski1981,CLAPHAM01102006} but see \citealt{Payne22052014}). They are of particular interest because they are a fairly common pattern observed in the fossil record \citep[e.g.][]{D'Hondt01011996,Coxall01042006,thorneresetting2011,bensonfaunal2014} and are often linked to major macroevolutionary processes such as adaptive radiation \citep{Losos2010} or competitive radiation \citep{Brusatte12092008}.

% 2ยง explaining the rise of the age of the mammals view.
One classical example of a shift in ecological dominance is at the Cretaceous-Palaeogene (K-Pg) mass extinction 66 million years ago (Mya) \citep{rennetime2013}, where the non-avian dinosaurs went extinct, potentially leading to the ``rise of the age of the mammals" \citep{archibald2011extinction,Lovergrove}. 
This is based on the idea that placental mammals were able to diversify after the extinction of many terrestrial vertebrates at the K-Pg boundary (including the dominant non-avian dinosaur group; \citealt{luo2007,archibald2011extinction,O'Leary08022013,Brusatte2015}).
Some authors suggest this reflects placental mammals filling the ``empty'' niches left after the K-Pg event \citep{archibald2011extinction}, others suggest it reflects a release from predation and/or competition \citep{Lovergrove}.
However, evidence for the diversification of placental mammals after K-Pg is mixed.
Thorough analysis of the fossil record \citep[e.g.][]{goswamia2011,O'Leary08022013} supports the idea that placental mammals diversified after K-Pg as there are no undebated placental mammal fossils before the K-Pg event and many afterwards \citep{archibald2011extinction,goswamia2011,Slater2012MEE,O'Leary08022013,Wilson2013,Brusatte2015}. 
Conversely, evidence from molecular data suggests that the diversification of placental mammals started prior to the K-Pg extinction event without being drastically affected by it \citep{Douady2003285,bininda2007delayed,meredithimpacts2011,Stadler12042011,beckancient2014}. 
Therefore, whether the diversification of placental mammals began before K-Pg, or in response to the extinctions at K-Pg, is a matter of great debate \citep{O'Leary08022013,Springer09082013,OโLeary09082013}. 

There are three main reasons why there is still debate about the timing of the diversification of placental mammals. In this paper we focus on solving these issues as follows: % NC: Needs a bit more finesse but you get the idea 
  \begin{enumerate}
    \item \textbf{Palaeontological and neontological data show different patterns.}
    As mentioned above, conclusions about when placental mammals diversified tend to be split depending on what kind of data are used: palaeontological data generally suggest that placental mammals diversified post K-Pg \citep[e.g.][]{O'Leary08022013}, whereas neontological data suggest that K-Pg event had little to no effect on mammalian diversification \citep{bininda2007delayed,meredithimpacts2011,Stadler12042011}. 
    Fortunately we can deal with this issue by using all the data available, rather than using just fossils or molecules. 
    Here we use Total Evidence phylogenies containing cladistic data for both living and fossil taxa along with molecular data for living taxa \citep{eernissetaxonomic1993,ronquista2012}, and using the tip-dating method \citep{ronquista2012,Wood01032013} to get accurate estimates of diversification times for both fossil and living species.
    \item \textbf{Diversity can be defined in different ways.}
    In fact, diversity is a difficult concept to define; in many studies it is measured as taxonomic diversity or species richness \citep{Stadler12042011,meredithimpacts2011,O'Leary08022013}, but often the more interesting aspect of diversity is related to the ecological niche the species occupy \citep{Wesley-Hunt2005,Brusatte12092008,toljagictriassic-jurassic2013} in order to draw hypothesis about the macroevolutionary processes \citep{Pearman2008149,OlsonRadiation,Losos2010,glor2010phylogenetic}.
    In addition, it is important to note that species richness variations can be decoupled from variations in morphological diversity \citep{slaterCetacean,ruta2013,hopkinsdecoupling2013}, so using only species richness may not be the best proxy for ecological diversity.
    In this study we therefore measure the variations in morphological diversity, also refereed as disparity \citep{Wills1994,BIJ:BIJ455,Wesley-Hunt2005,brusatte50,cisneros2010,prentice2011,anderson2012using,Hughes20082013,bentonmodels2014} as a way to quantify the changes in diversity in an ecological sense.
    \item \textbf{Methods are outdated and make inappropriate assumptions.}
    Finally, the methods used to quantify these changes were proposed more than 20 years ago \citep{Foote01071994,Wills1994} and are sometimes reused without revision even if they violate some basic statistic assumptions such as variables independence \citep{brusatte50,Brusatte12092008,cisneros2010,thorneresetting2011,prentice2011,brusattedinosaur2012,toljagictriassic-jurassic2013,ruta2013,bentonmodels2014,bensonfaunal2014}.
    Also, previous methods make the assumption that changes in disparity are only punctual \citep[e.g.][]{Wesley-Hunt2005} which has been shown to be not always the case \citep{Hunt21042015}.
    And finally, most of these studies that focused on changes of disparity through time used unequal time units based on biostratigraphy \citep{Brusatte12092008,brusattedinosaur2012,toljagictriassic-jurassic2013} which can be tautological since biostratigraphy is already based on changes in fossil assemblages and morphology through time.
    In this study we revise the statistical methods for measuring disparity.
    Also, we propose a new method called ``time-slicing'' allowing to look at changes in disparity through time in a continuous way along with the possibility of specifying the evolutionary model (punctuated or constant).
  \end{enumerate}

Here, we propose an updated approach to test whether mammals diversified before or after K-Pg, using morphological disparity as our measure of diversity.
We measured the cladistic disparity of two previously published studies \citep{Slater2012MEE,beckancient2014} based on both molecular and morphological data and using the Total Evidence trees dated using the tip-dating method \citep{ronquista2012,Wood01032013}.
Using a novel ``time-slicing'' approach we provide a fine grain estimation disparity through time and also allows us to make different assumptions about the evolutionary models underlying morphological character evolution (either constant or punctuated). 
Finally, to test whether mammals display significant changes in disparity after the K-Pg boundary, we compared the observed changes to two null model assuming purely stochastic or purely Brownian evolution. 
We found no significant increase in cladistic disparity after the K-Pg event and in fact the disparity in eutherian mammals spiked during the K-Pg event. 
These results suggest that the shift in dominant terrestrial vertebrate clades in the vertebrate fossil record during the Tertiary (from non-avian dinosaurs to eutherian mammals) is not due to the K-Pg extinctions.

%---------------------------------------------
%
%       METHODS
%
%---------------------------------------------

\section{Methods}

%To put somewhere:
%Methodological improvements
%Distance matrix: we use Graeme's MORD that more accurately reflects distances between taxa - Actually just Gower from now since Graeme's paper's not out for a while
%Disparity: we use the centroid distance that is a clear and easily-interpretable method that is less dependent from diversity (see supplementaries)
%Time: we use Total Evidence Tip dated trees that are more accurate because they use probabilistic methods to estimate morphological phylogenetic distance (Wright) and provide more accurate ages of diversification events (Ronquist).
%Disparity through time: Finally, we use a *novel method* (to our knowledge) to look at the diversity through time. Instead of calculating the disparity of all species present in a time interval (e.g. Butler and Brusatte), we calculate disparity at a set of arbitrary and equidistant points in time. This new method provides a finer grain resolution of the evolution of diversity through time as well as two well defined models of character evolution (pucntuated - random, acctran, deltran - and continuous - proximity) contrary to the time interval method that assumes only punctuated as a evolutionary model for morphological characters and can be biased towards biostratigraphy.


% NC: I'm not sure that this is necessary for this paper. It's much more linear that the previous one. You could save for the supp mat or your thesis 
%To test whether mammals display a significant change in disparity after the K-Pg boundary we use the following protocol (note that each step is explained in detail below this section; Fig.~\ref{fig_method}.
%\begin{enumerate}
%\item{Data: we used the cladistic morphological matrices and the Total Evidence tip-dated trees published in \citep{Slater2012MEE} and \citep{beckancient2014}.} \\
%\item{Estimating ancestral character states: we used the \citep{Yang01121995} re-rooting method to estimate the states of each characters in the cladistic morphological matrices at each node and created the reconstructed morphological matrix containing observed morphological characters data for tips in the tree and estimated morphological characters states for nodes.}\\
%\item{Calculating the cladisto-space: using the reconstructed morphological matrix we defined the cladisto-space by using a principal components ordination of the Gower distance matrix \citep{Gower71} representing the $n$ finite dimensional space that encompasses the total cladistic morphological variation of the taxa present in the analysis.} \\
%\item{Time slicing: we then separated the cladisto-space into subdivisions containing only the edges (nodes or/and tips) present every 5 million years from present (hereafter called "time-slices").} \\
%\item{Disparity through time: we then calculate the phylogenetic diversity as the number of edges present at each time-slice as well as the cladistic morphological disparity defined as the spread of the edges in the cladisto-space at each time-slice (distance from cladisto-space centroid \citep{finlay2015morphological}.} \\
%\item{Null model testing: finally, we compared the observed disparity to the expected disparity under two different null models: (1) the first one being a completely stochastic model where disparity is random at each point in time.; and (2) the second one being a $Mk_n$ model (as a proxy for Brownian evolution) where disparity increase is constant through time.} \\
%\end{enumerate}

%\begin{figure}[!htbp]
%\centering
%    \includegraphics[keepaspectratio=true]{Figures/MEthod_outline.pdf}
%\caption{General method outline. The grey section represents the Total Evidence data and tip dated trees from two published studies \citep{Slater2012MEE,beckancient2014}. \textbf{A}: We then estimated the ancestral characters states from the observed morphological matrices from both studies. we then calculated the distance matrix using the Gower distance \citep{Gower71} and performed a ordination of the distance matrix to create the cladisto-space. Finally, we divided the cladisto-space matrix using the Time slicing method to measure the changes in morphological disparity through time. \textbf{B}: we then generated two sets of a hundred simulated "null" matrices under two null models, the random matrix: a fully stochastic matrix; and the $Mk_n$ matrix: a matrix simulated under the $Mk_n$ model. We then applied the same procedure as for \textit{A} (ordinated distance matrix and time slicing) to calculate the disparity through time expected for purely random data and for a constant evolution model. Finally we compared our simulated disparity through time to our observed disparity through time to estimate if mammals displayed a significant increase in disparity after the K-Pg boundary.}
%\label{fig_method}
%\end{figure}


% TG: warning: the methods are particularly long and painfull I find. However, I've tried to describe each step thoroughly but it might be in to much details even for Evolution. Squiz as much as you want in the supplementaries!


\subsection{Cladistic data an phylogenies}
We used the cladistic morphological matrices and the Total Evidence tip dated trees \citep{ronquista2012} from \cite{Slater2012MEE} (103 taxa and 446 morphological characters) and \cite{beckancient2014} (102 taxa and 421 morphological characters).
We chose these two data sets because they have a similar number of taxa and morphological characters.
\cite{Slater2012MEE} ranges from 310 Million years ago (Mya - Late Carboniferous) to the present and focuses on Mammaliamorpha up to the family level.
\cite{beckancient2014} ranges from 170 Mya (Middle Jurassic) to the present and focuses on Eutheria up to a genus level.
We used the first and last occurrences as the temporal span of each taxon in our analysis \citep{Slater2012MEE,beckancient2014}.

\subsection{Estimating ancestral character states}
For both datasets we estimated the ancestral state of each character at every node in the tree using Maximum Likelihood.
We used the \texttt{rerootingMethod} function from the R package \texttt{phytools} version 0.4-45 \citep{phytools,R}.
This method performs a Maximum Likelihood estimation of the ancestral values and the variance of a Brownian motion process based on the re-rooting method of \citealt{Yang01121995}.
% NC: May need a bit more info here. Also you need to cite garland's original paper here too. TG: Not sure which Garland's paper??
We followed the method of \cite{Claddis} for treating missing data at the tips as any possible observed state for each character.
For example if a character has two observed states across every taxa (0 and 1), we attributed the multi-state ``0\&1" value to the tips with missing data giving an equal probability of being either 0 or 1.
This allows the ancestral node of a tip with missing data to be still estimated with no assumption other than the fact that the tip has one of the observed states.
%We tested the effect of this assumption against another model where each missing character is treated as ``?'' character. In this second model, the missing data (NA) is treated as a new character ``?'' and the state of the character at the node can then be 0, 1 or ``?''. This method is more conservative because it does not make the assumption that the unobserved characters for taxa with missing data is obligatory one of the states observed for that character. However, simulations show that the first method (treating missing data as multi-state characters) leads to less false positive ancestral state reconstruction than the second (treating missing data as ``?'' character). %link to supp % TG: I'm not sure if that's important here. Nobody cares about this I assume and it has not much to do here. Maybe in the thesis?
We preferred Maximum Likelihood methods to Bayesian methods because both methods have been shown to produce similar results \citep{royer-carenzichoosing2013} but Maximum Likelihood methods are several orders of magnitude faster than Bayesian ones (total analysis time $\sim$@1.2 CPU year). 

In order to remain conservative with the ancestral states reconstruction (especially when a high error is associated to the ancestral state), we only considered the ancestral state reconstruction with a scaled likelihood $\geq$ than 0.95.
We replaced the value of the ancestral states below this threshold by ``NA".
%However, for a matter of comparison, we also provided the results of the analysis without removing the ancestral state reconstruction with low scaled likelihoods intervals ($\leq$ 0.95). % link to supp % TG: I think that's unecessary: 'we reran the analysis with crappier values and got crappier results - no shit!'

\subsection{Estimating the cladisto-space}
To explore the variation in mammalian disparity through time (defined here as the variation in morphologies through time), we use a cladisto-space approach \citep{Foote01071994,Foote29111996,Wesley-Hunt2005,Brusatte12092008,Hughes20082013,friedmanexplosive2010,toljagictriassic-jurassic2013}. % TG: or just call it morphospace? I think morphospace is less correct as it is not the morpho/metric/logic-space but an approaximation of it through cladistic space but Hughes et al 2008 and others still call it morphospace...
This approach is similar to a morphospace based on continuous morphological data \citep[e.g.][]{friedmanexplosive2010,finlay2015morphological}, except the cladisto-space is an approximation of it based on cladistic data (i.e. the discrete morphological characters used to build a phylogenetic tree).
Mathematically, the cladisto-space is a $n$ dimension object that summarizes the distances between the taxa present in the cladistic matrix (see details below).
Because of it's inherent combinatory properties, a cladisto-space is a finite theoretical object limited by the product of the number of character states. In fact, a cladisto-space will be overloaded if the number of taxa is higher than the product of the number of character states. Therefore it is straightforward to make sure that the character space does not contain more taxa than it's maximal capacity (maximum 1.9$\times$$10^{181}$ taxa for \cite{Slater2012MEE} and 4.5$\times$$10^{159}$ taxa for \cite{beckancient2014}). % TG: or 1.9$\times$1.8googol and 4.9$\times$1.6googol. Or is that just useless (basically that is to make the point for one of Gavin's comment: "how do you know you haven't too much taxa to fit in the morphospace?")
Estimating the cladisto-space requires two computationally intuitive % TG: or remove that adjective?
 steps described in detail below: (1) calculating the distance matrix and (2) the ordination of the distance matrix. % TG: note however that Graeme seems to say the ordination part is useless in cladistic data case. I'm not sure if he's right and I didn't did any testing but his argument make sense: ordination is to summarize the data which is useful with continuous data but less with discrete characters. However statistically I'm not sure how the disparity calculation will work since it is traditionally done on the eigen vectors (PC scores) which is just a "scaling" of the values using the covariance matrix. Therefore, if I want to use just the distance matrix, I'm afraid I'll have to find a complex way to add the covariance to the variance without using the eigen values (that make life easier in this case). Also that'll lead to problems with negative covariance (see Cailliez correction below).

\subsubsection{Distance matrix}
We first calculate the pairwise distance Euclidean matrix of length $k$ where $k$ is the total amount of taxa in each study.
%For the rest of the paragraph, I have to version that are just ordered differently. V1 is the problems and then the solution and V2 is the corrections (solutions) because of the problems. 
%Version 1 - START
However, calculating the Euclidean distance between two taxa using cladistic data is not straightforward since (1) different pairs of taxa can have different amount of data in common or (2) even none at all \citep{anderson2012using}!
We therefore used the \cite{Gower71} distance for correcting for different amount of overlapping taxa (1).
This method divides the observed Euclidean pairwise distance by the number of comparable characters between the pair of taxa.
However, contrary to other distances such as the Generalised Euclidean Distance (GED; \citealt{Wills2001}), the Gower distance does not allow to calculate distance when taxa have no overlapping data (inapplicable distance) (2).
In the latter case we used the \texttt{TrimMorphDistMatrix} function from the \texttt{Claddis R} package \citep{Claddis} to remove pairs of taxa that didn't had any cladistic characters in common.
%Version 1 - END
%%Version 2 - START
% We measured the $k$$\times$$k$ distances using the Gower distance \citep{Gower71} that is the Euclidean distance between two taxa divided by the number of comparable characters. 
% Using the Gower distance therefore allows to correct for distances between two taxa that share many characters and that will be stochastically closer to each other than to taxa that have less characters in common.
% In the case of cladistic matrices, using this corrected distance is preferable to the raw euclidean distance because of it's ability to deal with discrete or/and ordinated characters as well as with missing data \citep{anderson2012using}.
% Contrary to other distances such as the Generalised Euclidean Distance (GED; \citealt{Wills2001}), the Gower distance does not allow to calculate distance when taxa have no overlapping data (inapplicable distance).
%% TG : maybe add a sentence on what the GED does and why we didn't want to use it?
% Therefore, we used the \texttt{TrimMorphDistMatrix} function from the \texttt{Claddis R} package \citep{Claddis} to remove pairs of taxa that didn't had any cladistic characters in common.
%%Version 2 - END
@/@ taxa had overlapping data in \cite{Slater2012MEE} and @/@ in \cite{beckancient2014}.
%We also calculated the Generalised Euclidean Distance (GED) \citep{Wills2001} which replaces inapplicable distances by the mean overall distance and the MORD distance (@Lloyd in prep.@) which scales the euclidean distance similarly to the Gower distance but by dividing the euclidean distance by the maximum overall distance rather than the number of shared characters. The results of theses calculations are available in the supplementaries % TG: or maybe not. Makes the supplementary super long and it's not something new (to use Gower).

\subsubsection{Ordination}
We then transformed the distance matrices using classic multidimensional scaling \citep{torgerson1965multidimensional,GOWER01121966,cailliez1983analytical}.
This method (similarly refereed as MDS; e.g. in \citealt{DonohueDim}; PCO; e.g. in \citealt{Brusatte2015}; or PCoA; e.g. \citealt{paradisape:2004}) is an eigen decomposition of the distance matrix.
Because we used the Gower distance instead of the raw Euclidean distances, negative eigenvalues can be calculated.
To avoid this, we transformed the distance matrix by applying the Cailliez correction \citep{cailliez1983analytical} which multiplies the distance matrix values (appart from the diagonal) by a constant $c^*$ (e.g. as used in \citealt{toljagictriassic-jurassic2013}).
This allowed to calculate $n$ eigen vector (i.e. the $n$ dimensions of the cladisto-space) where $n$ is equal to $k-1$ (i.e. $k$, the number of taxa in each matrix, \textit{minus} the last eigen vectors that is null after applying the Cailliez correction).
Contrary to previous studies \citep{brusatte50,cisneros2010,prentice2011,anderson2012using,Hughes20082013,bentonmodels2014}, we did use all the $n$ dimensions of the cladisto-space and not only a sub-sample of them bearing the majority of the variance (e.g. 90\% of the variance; \citealt{Brusatte12092008,toljagictriassic-jurassic2013}).

Following these two steps, we calculated the cladisto-spaces of both datasets.
Note that our cladisto-spaces represent an ordination of all the possible mammalian morphologies coded in each studies, not the cladistic disparity at any point in time.
Therefore, at any point in time, the disparity is expected to be always $\leq$ than the total disparity in the cladisto-space.

\subsection{Disparity}
As mentioned above, one aspect of diversity can be measured as the variation in morphologies: the morphological disparity \citep[e.g.][]{Wesley-Hunt2005,Brusatte12092008,toljagictriassic-jurassic2013}.
This can be estimated in many different ways \citep[e.g.][]{Ciampaglio2004,thorneresetting2011,hopkinsdecoupling2013,huang2015origins}, however numerous studies have estimated disparity using four main metrics: the sum and products of ranges and variances which all four gives an slightly different estimate of the multidimensional occupancy of the data within the cladisto-space \citep{Foote01071994,Wills1994,brusatte50,Brusatte12092008,cisneros2010,thorneresetting2011,prentice2011,brusattedinosaur2012,toljagictriassic-jurassic2013,ruta2013,bentonmodels2014,bensonfaunal2014}.
The sum and products of ranges and variances are based on the ranges and the variances of each eigen vectors calculated from the distance matrix but does not take into account the covariance between the eigen vectors.
This can only be statistically correct if the eigen vectors are independent.
In the case of a multidimensional scaling, the eigen vectors are calculated from the same distance matrix and are therefore not independent.
%Also one practical reason to not use the products of ranges or variances, when using the full cladisto-space (i.e. without excluding the last dimensions), is that the disparity values will tend towards 0 since the variance or ranges on the last axis are usually really close to 0. % TG: or maybe that's useless. We're already making the point that's it statistically incorrect. No need to add that it also doesn't work in practice, no?

However, including the covariance terms in these measurements is not straightforward and comes with properties specific to the number of dimension \citep{Jackson,DonohueDim}.
One potential solution is to measure the hyper-dimensional volume \citep{Wills1994,DonohueDim} but this volume based on the eigenvalue cannot be calculated through time (unless one recalculates the cladisto-space for each point in time).
Therefore, we chose to use a more intuitive metric measuring the dispersion of the data in the caldisto-space: the distance from centroid (\citealt{finlay2015morphological}; similar but not equivalent to \citealt{kornextinction2013,huang2015origins}):
%\begin{equation}
%Disparity=\frac{\sum{\sqrt{(kn_{i}-Centroid_{n})^2}}}{k}
%\end{equation}
%Where $k_{n}$ is any value of eigen vector of the $n^{th}$ dimension of the cladisto-space and $Centroid_{n}$ is the average value of the same $n^{th}$ eigen vector and $k$ is the size of the distance matrix (the total number of taxa).
\begin{equation}
Disparity=\frac{\sum{\sqrt{(Edge_{n}-Centroid_{n})^2}}}{Number\ of\ edges}
\end{equation}
Where $Edge_{n}$ is any phylogenetic edge value present in the subsection of data in the $n^{th}$ dimension of the cladisto-space and $Centroid_{n}$ is the average value of the $n^{th}$ dimension.
Note that we also measured the sum and the products of ranges and variances to compare our results with previous studies. % link to supp.
Using this disparity metric, we measured the disparity through time as the observed disparity in each subsections of the cladisto-space at each point in time.

\subsection{Time slicing}
Once the cladisto-space is calculated, one can measure the disparity through time as the dispersion of morphologies in subsets of taxa co-occurring at any point in time.
One classical way to study it is to look at which taxa occupies the cladisto-space during some time intervals and calculate the disparity of the taxa present during each interval \citep[e.g][]{cisneros2010,prentice2011,Hughes20082013,hopkinsdecoupling2013,bentonmodels2014,bensonfaunal2014}.
The time intervals are usually defined based on biostratigraphy \citep[e.g.][]{cisneros2010,prentice2011,Hughes20082013,bentonmodels2014} but can also be arbitrary chosen equal time periods \citep{hopkinsdecoupling2013,bensonfaunal2014}.
However, this method suffers from two main biases: first (1) the disparity can be distorted towards higher differences between time intervals.
For example, if biostratigraphy is used to determine the time intervals, it is likely to increase the differences between two strata since they were geologically defined on differences in the morphology of fossils found in the different strata.
Second (2) the time intervals method assumes that all characters evolve following a punctuated equilibrium model.
In fact, during one considered interval of time, the disparity is calculated as the morphological diversity during that period of time.
Then, during the next interval of time, if there is a difference in disparity, it assumes that the morphological diversity changed between the to time intervals.
However, it can be possible that the morphologies changed also in a continuous way between as well as within the intervals \citep{Hunt21042015}.

To address these issues, we propose a new ``time-slicing'' method that only considers subdivisions of the cladisto-space at specific equidistant points in time (as opposed to the time intervals that considers subdivisions of the cladisto-space between two points in time; see Fig.~\ref{fig_slicing}).
This methods addresses two of the biases introduced by the time intervals method: first (1) it allows to sample evenly through time and at a finer grain analysis without grouping certain edges together.
For example, the slice at 0 Mya will contain only the extant taxa instead of an interval defined as the Quaternary (from 2.5 Mya to the present) that will also include some extinct taxa.
In practice, this method considers the disparity of any element present in the phylogeny (branches, nodes and tips) at any point in time (see Fig.~\ref{fig_slicing}).
When the phylogenetic elements are edges (nodes or tips), the eigen vector scores for these edges are directly used for calculating disparity.
However, when the phylogenetic elements are branches it his highly probable, for vertebrate data, that the eigen vector score at any point in time is unknown (i.e. no observed edge).
We therefore incorporate to the ``time-slicing'' method a way to determine what the eigen vector score along a branch could be: (2) at any specific point in time, we propose two different models to determine whether to consider the data from the ancestor edge or the descendant one.
\begin{enumerate}
    \item{Punctuated evolution model:} this model selects either the data from the ancestor or the descendant edge.
    Similarly to the time interval method, this model reflects punctuated evolution where the changes occur either at the start or at the end of a branch during a really short period \citep{Gould1977}.
    In practice, we randomly chose the eigen vector scores from the ancestor or the descendant edge each time.
    However, we also tested the model with the assumption that changes always occurs early on the branch (accelerate transition, ACCTRAN) or are always delayed towards the descendant edge (delayed transition, DELTRAN).
    The result of both assumption are available in the supplementary material.
    \item{Constant evolution model:} this models selects either the eigen vector scores from the ancestor or the descendant edge according to the branch length separating the sampling point and the ancestor's edge.
    If the sampling point along the branch is lower than half the branch length, then the eigen vector scores from the ancestor edge is selected.
    Else we selected the eigen vector scores from the descendant edge.
    This model reflects constant evolution where changes rate are constant and cumulative along the branch (i.e. the hypothetical character state at any point in time will likely to be the same to the closest observed state in time - ancestor or descendant edge).
\end{enumerate}

% TG: not sure if this figure is useful and pretty sure that if it is, it should be improved!
\begin{figure}[!htbp]
\centering
    \includegraphics[keepaspectratio=true]{Figures/Slicing.pdf}
\caption{Differences in slicing method and intervals. Solid lines represent the First and Last Appearance Datum span. Interval 1 contains the following elements within the global character-space: taxa t2 and t8 and nodes n1, n2, n3, n4 and n5. Interval 2 contains the following elements within the global character-space: taxa t1, t2, t3, t4, t5, t6 and t7 and nodes n6 and n7. Slice 1 contains the following elements within the global character-space under the proximity model (constant evolution assumption): nodes n2 and n4. Slice 2 contains the following elements within the global character-space under the proximity model (constant evolution assumption): taxa t4 and t7.}
\label{fig_slicing}
\end{figure}

%What did we do (the main figure)
We applied this ``time-slicing'' method to the two cladisto-spaces calculated from \cite{Slater2012MEE} and \cite{beckancient2014} slicing the phylogeny every 5 million years from 170 Mya to the present resulting in 35 sub-samples of the cladisto-space.
For each sub-sample, we calculated the disparity assuming punctuated and constant evolution.
We bootstrapped 1000 times each disparity measurement for accounting for uncertainty.
We then calculated the median disparity value from each sub-sample along with the 50\% and the 95\% confidence intervals.
Along with disparity, we also reported the taxonomic richness in each sample defined as the log of the number of phylogenetic elements in each sub-samples (i.e. log of the total number of branches, nodes and tips per slice).

% TG: not sure about the placement of each section below maybe just add both in the supplementaries? Methods seems long enough like that. Maybe just add the following sentence

% Short version (long version goes in supplementaries) - START
To avoid bias due to the number of edges variation in each cladisto-space subdivision we also ran a rarefaction analysis by re-sampling each subdivision to have an equal number of phylogenetic elements available (edges or branches). % link to supplementary
Additionally, in order to make our results comparable with previous studies, we also calculated the sum and products of ranges and variances \citep{Foote01071994,Wills1994} on the sub-samples of the cladisto-space.
We also applied a time interval method based on biostraptigraphy \citep[e.g.][]{cisneros2010,prentice2011,Hughes20082013,bentonmodels2014} where we used each geological stages from the Middle Jurassic to the present as well as a time interval method based on equal time periods of 20 million years \citep{hopkinsdecoupling2013,bensonfaunal2014}.
These additional studies are available in the supplementary materials. % link
% Short version (long version goes in supplementaries) - END

% Long version - START
% To avoid bias due to the number of edges variation in each cladisto-space subdivision we also re-sampled each subdivision to have an equal number of phylogenetic elements available (edges or branches).
% Each subdivision was therefore re-sampled to contain the minimal number of taxa in the smallest subdivision.
% Because this led in certain cases to a absolute minimum of phylogenetic elements to calculate disparity we also re-sampled the subdivisions to contain at maximum the modal number of phylogenetic elements between each sub-sample of the cladisto-space.
% In practice, for both cases, we bootstrapped the disparity measurements by randomly removing $x$ elements per subdivision, where $x$ is either (1) the number of edges sampled in each time slice minus the minimum of edges in each time slice or (2) the number of edges to remove so that the number of elements is not higher than the modal number of edges.
% Both results are available in the supplementary materials.

% In order to make our results comparable with previous studies, we also calculated the sum and products of ranges and variances \citep{Foote01071994,Wills1994} on the sub-samples of the cladisto-space.
% We also applied a time interval method based on biostraptigraphy \citep[e.g.][]{cisneros2010,prentice2011,Hughes20082013,bentonmodels2014} where we used each geological stages from the Middle Jurassic to the present as well as a time interval method based on equal time periods of 20 million years \citep{hopkinsdecoupling2013,bensonfaunal2014}.
% For both time interval analysis, we calculated the disparity as the distance from centroid \citep{finlay2015morphological} as well as the sum and products of ranges and variances \citep{Foote01071994,Wills1994}.
% These additional studies are available in the supplementary materials. %link 
% Long version - END

\subsection{Null models testing}
Finally, we tested the effect of the K-Pg boundary on mammal disparity, by measuring whether the observed changes were significantly different than expected by chance.
We reran the full disparity analysis ($minus$ the ancestral states reconstruction part) on both phylogenies with the same number of edges and the same time slices.
However, we replaced the observed character matrices by randomly generated ones following two null models.
The first null model (repeated 100 times) was a purely stochastic matrix where each cell value was sampled from a discrete uniform distribution with a number of sates equal to the number of states observed in the the original data.
For the second null model, we simulated each characters for each edge using the phylogenetic structure using the \texttt{sim.character} function from the \texttt{diversitree R} package \citep{fitzjohndiversitree2012} and the $Mk_n$ \citep{lewisa2001} with an equal transition rate between the number of characters states observed in the original matrix and a unique rate ($\mu$) sampled from a uniform distribution (0 $<$ $\mu$ $\leq$ 0.5). 
% We then measured the amount of overlap between both null models and the observed data using the Bhattacharyya Coefficient \citep{Bhattacharyya} which measures the probability of overlap between two distributions (similarly as a two sided \textit{t-test}; \citep{GuillermeCooper}.
% We considered the observed data to be non different than random for a Bhattacharyya Coefficient $>$0.95 and on the opposite, we considered a significant difference in disparity than expect by chance when the Bhattacharyya Coefficient was $<$0.05.
% OR actually maybe just go for anova... The problem is again that for our null data we have the full bootstrapped distribution (1000000 data points) to compare to the observed bootstrapped distribution (1000 points). Frequentist test will be a bit shitty (anyway because of the huge difference between the two distributions (observed and null) the results will be significant even if I only sample 10 data points in each distributions...). Maybe just add both? t-test + Bhattacharrya?
%---------------------------------------------
%
%       RESULTS
%
%---------------------------------------------

\section{Results}

%---------------------------------------------
%
%       DISCUSSION
%
%---------------------------------------------

\section{Discussion}

%Disparity improvements
%Previous studies have calculated disparity on a subset of PCO axes \citep[e.g.][]{Brusatte12092008} but in this study we calculated it on all the available axis (i.e. the full n dimensional cladisto-space) to avoid excluding outliers.

%Biases:
%-internal versus terminal branches
%-ancestral states reconstruction (solved by being conservative?)
%-poor sampling of living taxa (Guillerme & Cooper)

%From Wilson 2013
%My results reveal several key findings: (1) latest Cretaceous mammals, particularly metatherians and multituberculates, had a greater ecomorphological diversity than is generally appreciated, occupying regions of the morphospace that are interpreted as strict carnivory, plant-dominated omnivory, and herbivory; (2) the decline in dental-shape disparity and body-size disparity across the K/Pg boundary shows a pattern of constructive extinction selectivity against larger-bodied dietary specialists, particularly strict carnivores and taxa with plant-based diets, that suggests the kill mechanism was related to depressed primary productivity rather than a globally instantaneous event; (3) the ecomorphological recovery in the earliest Paleocene was fueled by immigrants, namely three multituberculate families (taeniolabidids, microcosmodontids, eucosmodontids) and to a lesser extent archaic ungulates; and (4) despite immediate increases in the taxonomic richness of eutherians, their much-celebrated post-K/Pg ecomorphological expansion had a slower start than is generally perceived and most likely only began 400,000 to 1 million years after the extinction event.


%Therefore, the cladisto-space is likely to be more influenced by phylogeny than the morphospace \citep{Foote29111996,Wagner01011997}. However, discrete cladistic characters are still the best source for quantifying overall morphology for large and diverse groups \citep{Brusatte12092008}. % NC: Make this justification better. why does the phylogney effect matter. Should this be mentioned here at all? TG: not specially, might be something a reviewer might point out. I remember you pointing it out ;). However, STD is become fairly common these days so maybe people have accepted the idea.

% Placental vs eutherian? Cartmill blogpost

%---------------------------------------------
%
%       CONCLUSION
%
%---------------------------------------------

\section{Conclusion}
%Not much stuff is happening there but we bring improvement to methods.


%---------------------------------------------

\section{Data availability and reproducibility}

\section{Acknowledgments}
Graeme Lloyd, Gavin Thomas, Sive Finlay.
%Simulations used the Lonsdale cluster maintained by the Trinity Centre for High Performance Computing and funded through grants from Science Foundation Ireland. %TG: I think they won't in the end

\section{Funding} % NC: Usually this is part of acknowledgments.
This work was funded by a European Commission CORDIS Seventh Framework Programme (FP7) Marie Curie CIG grant (proposal number: 321696).

 %   \citept{key} ==>>                Jones et al. (1990)
 %   \citept*{key} ==>>               Jones, Baker, and Smith (1990)
 %   \citep{key} ==>>                (Jones et al., 1990)
 %   \citepp*{key} ==>>               (Jones, Baker, and Smith, 1990)
 %   \citepp[chap. 2]{key} ==>>       (Jones et al., 1990, chap. 2)
 %   \citep[e.g.][]{key} ==>>        (e.g. Jones et al., 1990)
 %   \citepp[e.g.][p. 32]{key} ==>>   (e.g. Jones et al., p. 32)
 %   \citepauthor{key} ==>>           Jones et al.
 %   \citepauthor*{key} ==>>          Jones, Baker, and Smith
 %   \citepyear{key} ==>>             1990

\bibliographystyle{sysbio}
\bibliography{References}

\section{supplementaries}

\subsection{Ancestral states estimation}
We used both the \texttt{ace} function from the R package ape v. 3.2 \citep{paradisape:2004} and the 
\texttt{rerootingMethod} function from the R package phytools 0.4-45 \citep{phytools}. Both method perform a maximum likelihood estimation of the ancestral values and the variance of a Brownian motion process based on the re-rooting method of \citep{Yang01121995}. The two methods differ slightly in the calculation of the normalized conditional likelihoods but mainly on the way to treat missing data. We optimised the \texttt{ace} function for fast estimation by treating missing data in the matrix as an extra character (e.g. if a character has two observed tips states 0 and 1 and a third tip has missing data (NA), the ancestor of these three tips can be estimated between the three following states: 0, 1 and NA). For the \texttt{rerootingMethod}, we followed \citep{Claddis} method and treated the missing in the tips as any possible observed state (e.g. if a character has two observed tips states 0 and 1 and a third tip has missing data (NA), the third tip will be considered as multi-state (0\&1) and the ancestor of these three tips can be estimated between the two following states: 0 and 1). Both methods perform similarly but the implementation of the \texttt{ace} function has a slightly lower accuracy  but is three times faster than the one for the \texttt{rerootingMethod} function (see supplementaries).
% NC: Some of this probably belongs in methods

\subsubsection{Time intervals}
We then divide our observed cladisto-spaces into sub cladisto-spaces representing the different stages of the character-space filling. For example, if at various points in time.
%The intervals should be a compromise between the resolution and the sample size and must be "sufficiently coards that nearly all generic first and last occurenaces can be unambiguously assigned" \citep{Foote01071994}.
Time intervals from 170Ma (Earliest Cenomanian, Late Cretaceous) to the present.
We count all the nodes/tips present in a given time interval.
Classic but artificially grouping data. The minimal bin size should contain at least two nodes/tips and sometime that involves having time intervals spanning accross tens of millions of years. Such long duration time intervals have no real biological meaning since it is unlikely that all of the nodes/tips present in the time interval did ever coexisted and had ever biological interactions together.

\subsection{Diversity}
-Diversity in living mammals
-Diversity per interval

\subsection{Disparity}
-Centroid is less correlated with diversity
-Other metrics

\subsection{Not to be in the paper, neither in the supplementaries (methods table)}

\begin{table}[ht]
\caption{Comparison of Cladisto-space studies methods}
\centering
\begin{tabular}{cccccccc}
  \hline
    Date & Author      & Distance  & axis & Binning    & Disparity   & Difference & cite \\ %
  \hline
         & this study  & Gower     & PCO        & Time slice & centroid    & NPMANOVA?  & \\
    2014 & Benson      &           &            & Equal bins & Wills 1994* & NPMANOVA   & \citep{bensonfaunal2014} \\
    2014 & Brusatte    & Euclidean & PCO        &            &             &            & \citep{brusattegradual2014} \\
    2014 & Benton      & Euclidean & PCO        & Biostrat   & Wills 1994* & NPMANOVA   & \citep{bentonmodels2014} \\
    2013 & Hopkins     &           &            & Equal bins & Wills 1994* &            & \citep{hopkinsdecoupling2013} \\             
    2013 & Ruta        & GED       & 10 first   & Biostrat   & Wills 1994* & NPMANOVA   & \citep{ruta2013} \\
    2013 & Hughes      & Euclidean &            & Biostrat   & Sum of var  &            & \citep{Hughes20082013} \\
    2013 & Toljagic    & Euclidean & 90\% var   & Biostrat   & Wills 1994* & NPMANOVA   & \citep{toljagictriassic-jurassic2013} \\
    2012 & Brusatte    & Euclidean & 90\% var   & Biostrat   & Wills 1994* & CI overlap & \citep{brusattedinosaur2012} \\
    2012 & Anderson    & Gower     & PCO        &            &             &            & \citep{anderson2012using} \\
    2010 & Prentice    & Euclidean & PCO        & Biostrat   & Wills 1994* & NPMANOVA   & \citep{prentice2011} \\
    2011 & Thorne      & Euclidean &            & Biostrat   &             & NPMANOVA   & \citep{thorneresetting2011} \\
    2010 & Cisneros    & Euclidean & PCO        & Biostrat   & Wills 1994* & NPMANOVA   & \citep{cisneros2010} \\
    2008 & Brusatte    & Euclidean & 90\% var   & Biostrat   & Wills 1994* & NPMANOVA   & \citep{brusatte50} \\
    2008 & Brusatte    & Euclidean & 90\% var   & Biostrat   & Wills 1994* & NPMANOVA   & \citep{Brusatte12092008} \\
    2005 & Wesley-Hunt &           & PCO        &            & Foote 1992  & t-test     & \citep{Wesley-Hunt2005} \\
  \hline
\end{tabular}
\end{table}
* The 4 sum and product of range and variance




\end{document}
